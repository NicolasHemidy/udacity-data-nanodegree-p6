<html>
<div id="chartContainer">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>
  <script type="text/javascript">
      var svg = dimple.newSvg("#chartContainer", 1180, 800);
      d3.tsv("data.tsv", function (data) {

          // Add chart title
          svg.append("text")
            .attr("x", 110)
            .attr("y",50)
            .attr("width",1180)
            .style("font-family", "lato")
            .style("font-size", "26px")
            .style("font-weight", "500")
            .style("color", "Black")
            .text("How does teachers behaviour influence students attitude towards school across the world?");

          // Add chart description
          svg.selectAll("description_text")
                  .data(["Students attitude towards school is certainly a factor of success. As you'll see below, students considering school as a waste of time tend","to have lower math scores.", "An other interesting observation is the relationship between students attitude and their perception of their teacher. Students considering"," their teacher unfair tend to consider school as a waste of time and tend to have lower math score."])
                  .enter()
                  .append("text")
                  .attr("x", 110)
                  .attr("y", function (d, i) { return 90 + i * 22; })
                  .style("font-family", "lato")
                  .style("font-size", "18px")
                  .style("color", "Black")
                  .style("font-weight", "300")
                  .text(function (d) { return d; });

          // Filter for student - teacher relation
          data = dimple.filterData(data, "Treat Students Fair", [
              "Strongly disagree", "Disagree", "Agree", "Strongly agree"
          ]);

          // Create the indicator chart on the right of the main chart
          var indicator = new dimple.chart(svg, data);

          // Pick blue as the default and orange for the selected month
          var defaultColor = indicator.defaultColors[6];
          var indicatorColor = indicator.defaultColors[2];


          // The frame duration for the animation in milliseconds
          var frame = 8000;

          var firstTick = true;

          // Place the indicator bar chart to the right
          indicator.setBounds(868, 298, 306, 452);

          // Add dates along the y axis
          var y = indicator.addCategoryAxis("y", "Treat Students Fair");
          y.addOrderRule(["Strongly disagree","Disagree","Agree","Strongly agree"]);

          // Use sales for bar size and hide the axis
          var x = indicator.addMeasureAxis("x", "count");
          x.showGridlines = false;
          x.fontFamily = "lato";
          x.fontSize = "12px";

          // Add the bars to the indicator and add event handlers
          var s = indicator.addSeries(null, dimple.plot.bar);
          s.addEventHandler("click", onClick);
          // Draw the side chart
          indicator.draw();

          // Remove the title from the y axis
          y.titleShape.remove();

          // Remove the lines from the y axis
          y.shapes.selectAll("line,path").remove();

          // Move the y axis text inside the plot area
          y.shapes.selectAll("text")
                  .style("text-anchor", "start")
                  .style("font-size", "14px")
                  .attr("transform", "translate(18, 0.5)");

          // This block simply adds the legend title. I put it into a d3 data
          // object to split it onto 2 lines.  This technique works with any
          // number of lines, it isn't dimple specific.

          // Manually add legend title
          svg.append("text")
              .attr("x", 870)
              .attr("y",230)
              .style("font-family", "lato")
              .style("font-size", "18px")
              .style("font-weight", "500")
              .style("color", "Black")
              .text("Does my teacher treat students fair?");

          // MAnually add legend description
          svg.selectAll("title_text")
                  .data(["Click bar to select and pause.",
                      "Click again to resume animation"])
                  .enter()
                  .append("text")
                  .attr("x", 870)
                  .attr("y", function (d, i) { return 260 + i * 12; })
                  .style("font-family", "lato")
                  .style("font-size", "12px")
                  .style("color", "Black")
                  .style("font-style", "italic")
                  .text(function (d) { return d; });



          // Manually set the bar colors
          s.shapes
                  .attr("rx", 5)
                  .attr("ry", 5)
                  .style("fill", function (d) { return (d.y === 'Strongly agree' ? indicatorColor.fill : defaultColor.fill) })
                  .style("stroke", function (d) { return (d.y === 'Strongly agree' ? indicatorColor.stroke : defaultColor.stroke) })
                  .style("opacity", 0.3);

          // Draw the main chart
          var bubbles = new dimple.chart(svg, data);
          bubbles.setBounds(120, 230, 710, 520)
          var xx = bubbles.addCategoryAxis("x", "Waste of time");
          var yy = bubbles.addMeasureAxis("y", "mean");
          bubbles.addMeasureAxis("z", "count");
          yy.addOrderRule(["Strongly disagree","Disagree","Agree","Strongly agree"]);
          yy.overrideMax = 650;
          yy.fontSize = 12;
          yy.fontFamily = "lato";
          xx.fontSize = 12;
          xx.fontFamily = "lato";
          bubbles.addSeries(["OECD"], dimple.plot.bubble)
          var leg = bubbles.addLegend(140, 200, 400, 120);
          leg.fontSize = 14;
          leg.fontFamily = "lato";

          // Add a storyboard to the main chart and set the tick event
          var story = bubbles.setStoryboard("Treat Students Fair", onTick);
          // Change the frame duration
          story.frameDuration = frame;
          // Order the storyboard by date
          story.addOrderRule(["Strongly agree","Agree","Disagree","Strongly disagree"]);

          // Draw the bubble chart
          bubbles.draw();

          // Orphan the legends as they are consistent but by default they
          // will refresh on tick
          bubbles.legends = [];
          // Remove the storyboard label because the chart will indicate the
          // current month instead of the label
          story.storyLabel.remove();

          // On click of the side chart
          function onClick(e) {
              // Pause the animation
              story.pauseAnimation();
              // If it is already selected resume the animation
              // otherwise pause and move to the selected month
              if (e.yValue === story.getFrameValue()) {
                  story.startAnimation();
              } else {
                  story.goToFrame(e.yValue);
                  story.pauseAnimation();
              }
          }

          // On tick of the main charts storyboard
          function onTick(e) {
              if (!firstTick) {
                  // Color all shapes the same
                  s.shapes
                          .transition()
                          .duration(frame / 2)
                          .style("fill", function (d) { return (d.y === e ? indicatorColor.fill : defaultColor.fill) })
                          .style("stroke", function (d) { return (d.y === e ? indicatorColor.stroke : defaultColor.stroke) });
              }
              firstTick = false;
          }
      });
  </script>
</div>
</html>
